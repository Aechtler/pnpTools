<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="src/style/app.min.css" rel="stylesheet">
    <title>Pen&Paper Tools: INI Calculator</title>
</head>
<body>
    <div id="app" class="container">
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                <div v-if="!starts">
                    <h1 class="display-4"><i class="fas fa-skull"></i> Add NPC</h1>
                    <div class="npcCreator">
                        <div class="npcCreator__col"><input v-model="npc.at" class="form-control" type="number" min="0" placeholder="AT" /></div>
                        <div class="npcCreator__col"><input v-model="npc.pa" class="form-control" type="number" min="0" placeholder="PA" /></div>
                        <div class="npcCreator__col"><input v-model="npc.ini" class="form-control" type="number" min="0" placeholder="INI" /></div>
                        <div class="npcCreator__col"><input v-model="npc.le" class="form-control" type="number" min="0" placeholder="LE" /></div>
                        <div class="npcCreator__col"><button class="btn" :class="{'btn-primary': isValidNPC(), 'btn-secondary': !isValidNPC()}" @click="addNPC()" :disabled="!isValidNPC()"><i class="fas fa-plus"></i></button></div>
                    </div> 
                </div> 
                <div v-if="starts">
                    <h1 class="display-4"><i class="fas fa-flag"></i> Round: {{roundCount}}</h1>
                </div>
            </div>
        </div>

        <div class="player">
            <h2>Players</h2>
            <div class="player-list" 
                v-for="player in players" 
                :key="player.id" 
                :class="{'table-active': checkStatus('isPlayerActive', player), 'table-danger': !checkStatus('isPlayerAlive', player)}">
                <div class="player-list__row">
                    <div class="player-list__col player-list__col--status">
                        <div class="player-list__col-item">
                            <i v-if="checkStatus('isNPCActive', player)" class="fas fa-skull"></i>
                            <i v-if="checkStatus('isPlayerInLine', player)" class="fas fa-user"></i>
                            <i v-if="checkStatus('isPlayerNotInLine', player)" class="far fa-user"></i>
                            <i v-if="checkStatus('isPlayerDead', player)" class="fas fa-skull-crossbones"></i>
                        </div>
                    </div>
                    <div class="player-list__col player-list__col--name" :class="{'player-list__col player-list__col--npc': player.npc}">
                        <div class="player-list__col-item">{{player.name}}</div>
                    </div>
                    <div class="player-list__col player-list__col--at" v-if="player.npc">
                        <div class="player-list__col-item" >AT: {{player.fightAttributes.atn}}</div>
                    </div>
                    <div class="player-list__col player-list__col--pa" v-if="player.npc">
                        <div class="player-list__col-item">PA: {{player.fightAttributes.pa}}</div>
                    </div>
                </div>
                <div class="player-list__row player-list__row--second">
                    <div class="player-list__col player-list__col--le">
                        <div class="player-list__col-item">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1"><i class="fas fa-heart"></i></span>
                                </div>
                                <input :disabled="!starts" class="form-control" type="number" v-model="player.le" aria-describedby="basic-addon1"/>
                            </div>
                        </div>
                    </div>
                    <div class="player-list__col player-list__col--options">
                        <div class="player-list__col-item">
                            <button type="button" class="btn btn-light" v-if="players.length > 2 || !starts" @click="dropPlayer(player.id)">
                                <i class="fas fa-user-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="players.length < 2">
                <div class="alert alert-warning">
                    <strong>Achtung!</strong> Es müssen mindestens zwei Spieler für ein Kampf bereit sein.
                </div>
            </div>
        </div>
        
        <div v-if="!starts">
            <button type="button" class="btn btn-secondary" @click="restart()"><i class="fas fa-redo-alt"></i></button>
            <button type="button" class="btn" :class="{'btn-primary': players.length > 1, 'btn-secondary': players.length <= 1}" @click="startBattle()" :disabled="players.length < 2">Lets Fight! <i class="fas fa-fist-raised"></i></button>
        </div>

        <div v-if="starts">
            <button type="button" class="btn btn-secondary" @click="reload()"><i class="fas fa-redo-alt"></i></button>
            <button type="button" class="btn btn-secondary" @click="restart()"><i class="fas fa-stop"></i></button>
            <button type="button" class="btn btn-primary" @click="nextRound(true)">Next <i class="fas fa-caret-right"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash"></script>
    <script src="players.js"></script>
    <script>
        const vm = new Vue({
            el: '#app',
            data: {
                buPlayers: [],
                players: players || [],
                roundCount: 1,
                iniRoundCount: 1,
                playersLeft: [],
                activePlayer: null,
                starts: false,
                npcCount: 0,
                npc: {}
            },
            methods: {
                nextRound(click) {
                    if (click) this.roundCount++;

                    if (!this.playersLeft.length) {
                        this.iniRoundCount++
                    }

                    this.getActivePlayer();

                    return true;
                },
                startBattle() {
                    this.starts = true;
                    this.buPlayers = this.clone(this.players);
                    this.getActivePlayer();
                },
                getActivePlayer() {
                    if (this.playersLeft.length){
                        this.activePlayer = this.playersLeft.pop().id;
                        return true;
                    }

                    var currentPlayers = [];

                    this.players.forEach(player => {
                        if(this.iniRoundCount % player.fightAttributes.ini === 0 && player.le > 0) {
                            currentPlayers.push(player)
                        }
                    });

                    switch(currentPlayers.length) {
                        case 0:
                            this.nextRound();
                            break;
                        case 1:
                            this.activePlayer = currentPlayers[0].id;
                            break;
                        default:
                            this.activePlayer = this.getStrongestPlayer(currentPlayers);
                    }
                },
                getStrongestPlayer(currentPlayers) {
                    var sortedPlayers = _.sortBy(currentPlayers, [function(player) { 
                            return player.mainAttributes.kk; 
                        }]);
                    var lastPlayer = sortedPlayers.pop();

                    this.playersLeft = sortedPlayers;

                    return lastPlayer.id;
                },
                clone(object) {
                    var output, v, key;
                    output = Array.isArray(object) ? [] : {};
                    for (key in object) {
                        v = object[key];
                        output[key] = (typeof v === "object") ? this.clone(v) : v;
                    }
                    return output;
                },
                reload() {
                    this.iniRoundCount = 1;
                    this.roundCount = 1;
                    this.players = this.clone(this.buPlayers);
                    this.playersLeft = [];
                    this.getActivePlayer();
                },
                isValidNPC() {
                    var isValid = this.npc.ini && this.npc.at && this.npc.pa && this.npc.le;
                    return isValid ? true : false;
                },
                checkStatus(status, player) {
                    var isPlayerNPC = player.npc;
                    var isPlayerAlive = player.le > 0;
                    var isPlayerActive = this.activePlayer === player.id;

                    switch(status) {
                        case 'isNPCActive':
                            return isPlayerNPC && isPlayerAlive;
                            break;
                        case 'isPlayerDead':
                            return !isPlayerAlive;
                            break;
                        case 'isPlayerInLine':
                            return !isPlayerNPC && isPlayerAlive && isPlayerAlive;
                            break;
                        case 'isPlayerNotInLine':
                            return !isPlayerNPC && !isPlayerAlive && isPlayerAlive;
                            break;
                        case 'isPlayerActive':
                            return isPlayerActive;
                            break;
                        case 'isPlayerAlive':
                            return isPlayerAlive;
                            break;
                        default:
                            return false;
                    }
                },
                addNPC() {
                    if (!this.isValidNPC()) {
                        return false;
                    }

                    this.npcCount++;
                    var npc = {
                        "id": 'NPC' + this.npcCount,
                        "name": "NPC (" + this.npcCount + ")",
                        "npc": true,
                        "le": this.npc.le,
                        "mainAttributes": {
                            "kk": 1
                        }, 
                        "fightAttributes": {
                            "ini": this.npc.ini,
                            "atn": this.npc.at,
                            "pa": this.npc.pa
                        }
                    };

                    this.players.push(npc);

                    return npc;
                },
                restart() {
                    window.location.reload();
                },
                dropPlayer(playerId) {
                    this.players = _.remove(this.players, function(player) {
                        return player.id !== playerId;
                    });

                    this.playersLeft = _.remove(this.playersLeft, function(player) {
                        return player.id !== playerId;
                    });

                    if (this.starts) this.getActivePlayer();

                    return true;
                }
            }
        });
    </script>
</body>
</html>